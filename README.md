# Демо движка управляемого повествования
Backend-сервис, предоставляющий API для фронтенд-приложения и реализующий сложную логику взаимодействия с LLM для обеспечения когерентного, управляемого сюжетом ролевого опыта для пользователя.

## Технологический стек
- **Язык программирования:** Python 3.10+
- **Веб-фреймворк:** FastAPI
- **Веб-сервер:** Uvicorn
- **Валидация данных:** Pydantic
- **ИИ-фреймворк:** LangChain
- **Векторная база данных:** ChromaDB (локальная)
- **Внешние сервисы:** Google Gemini API

## Архитектура 
Сервис построен на базе "Оркестратора", реализующего двух- или трехконтурную RAG-архитектуру:
- Сам **Оркестратор** — основной логический модуль, получает запросы от API, управляет вызовами RAG-контуров и LLM.
- **Первый контур** — векторная база данных, хранящая неизменные правила поведения, стиля речи и личности ИИ-персонажа (в будущем — и личность персонажа пользователя), обеспечивает _стабильность роли_.
- **Второй контур** — векторная база даннных, хранящая динамически обновляемые краткие содержания (summmary) предыдущих сцен, обеспечивает _долгосрочную память внутри диалога_.
- **Третий контур** — векторная база данных, хранящая чек-поинты сюжета, обеспечивает _следование сюжетной тропе_ (важен для режима **Сценарий**, опускается в режиме **Песочницы**).

## API Эндпоинты
- `POST /api/v1/chat` — основной эндпоинт для обработки ответа пользователя, запускает Оркестратора для генерации ответа ИИ.
- `GET /api/v1/characters` — получение списка всех доступных ИИ-персонажей.
- `GET /api/v1/scenarios` — получение списка всех доступных сценарией (для режима **Сценарий**).

## Как запустить проект

### Предварительные требования
- Python 3.10+
- Node.js 18+ и npm
- Google Gemini API ключ ([получить здесь](https://aistudio.google.com/app/apikey))

### Шаг 1: Настройка Backend

```bash
# Установить зависимости Python
pip install -r requirements.txt

# Создать файл .env и добавить API ключ
cp .env.example .env
# Отредактировать .env и добавить: GEMINI_API_KEY=your_key_here

# Инициализировать векторную базу данных
python scripts/initialize_db.py

# Запустить backend сервер
python main.py
```

Backend будет доступен на `http://localhost:8000`

### Шаг 2: Настройка Frontend

```bash
# Перейти в папку frontend
cd frontend

# Установить зависимости
npm install

# Запустить dev сервер
npm run dev
```

Frontend будет доступен на `http://localhost:5173`

### Шаг 3: Использование

1. Откройте браузер и перейдите на `http://localhost:5173`
2. Нажмите на кнопку "API Key" в правом верхнем углу и введите ваш Gemini API ключ
3. Нажмите "New Adventure" для создания новой игровой сессии
4. Выберите персонажа, стиль повествования и режим игры
5. Создайте своего персонажа и начните приключение!

### Альтернатива: Консольное приложение

```bash
python console_app.py
```

## План разработки
- [x] Настроить базовый проект: структура проекта, файл зависимостей, безопасное хранение API-ключа и базовый эндпоинт.
- [x] Написать скрипт, который читает данные о персонажах и сценариях из JSON-файлов, векторизует их и загружает в ChromaDB.
- [x] Написать функцию, которая извлекает правила из DB_Rules (первый контур).
- [x] Написать функцию, которая принимает историю чата, создает саммари (пока просто берет последние N сообщений), векторизует и ищет релевантные моменты в DB_History (второй контур).
- [x] Написать функцию, которая извлекает активный чек-поинт (третий контур).
- [x] Создать главную функцию, которая вызывает три контура, собирает из их результатов финальный промпт и отправляет его в Gemini API.
- [x] Подключить Оркестратор к эндпоинту чата (простая фронтенд-часть).
...
